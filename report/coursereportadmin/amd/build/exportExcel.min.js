define("report_coursereportadmin/exportExcel",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;_exports.init=(XLSX,filesaver,blobutil)=>{const boexportAss=document.querySelector("#id_export_ass"),boexportAtt=document.querySelector("#id_export_att"),boexportTrainee=document.querySelector("#id_export_trainee");boexportAss.addEventListener("click",(e=>{exportToExcel(e,XLSX,filesaver,blobutil,"coursereport")})),boexportAtt.addEventListener("click",(e=>{exportToExcel(e,XLSX,filesaver,blobutil,"dailyattendancereport")})),boexportTrainee.addEventListener("click",(e=>{exportToExcel(e,XLSX,filesaver,blobutil,"traineereport")}))};const exportToExcel=(e,XLSX,filesaver,blobutil,op)=>{const token=document.querySelector('input[name="token"]').value;prepareDataToSend(token,op)},prepareDataToSend=(token,op)=>{const xhr=new XMLHttpRequest,url="http://"+window.location.hostname+"/webservice/rest/server.php";xhr.open("POST",url,!0);const formData=new FormData;switch(formData.append("wstoken",token),op){case"coursereport":formData.append("wsfunction","report_coursereportadmin_get_total_assessment");break;case"dailyattendancereport":formData.append("wsfunction","report_coursereportadmin_get_total_dailyattendance");break;case"traineereport":formData.append("wsfunction","report_coursereportadmin_get_total_trainee_report")}formData.append("moodlewsrestformat","json"),formData.append("params[0][request]",op),xhr.send(formData),xhr.onload=event=>{onLoadFunction(xhr,op)},xhr.onprogress=event=>{onProgressFunction(event)},xhr.onerror=function(){window.console.log("Solicitud fallida")}},onLoadFunction=(myXhr,op)=>{const loader=document.querySelector(".loader");if(loader.classList.add(".hide"),loader.classList.remove(".show"),4===myXhr.readyState&&200===myXhr.status){const res=JSON.parse(myXhr.response);switch(op){case"coursereport":createExcelFromJSON(res,"courseReport");break;case"dailyattendancereport":createExcelFromJSON(res,"dailyAttendanceReport");break;case"traineereport":createExcelFromJSON(res,"traineeReport")}}},onProgressFunction=event=>{console.log("Uploaded ".concat(event.loaded," of ").concat(event.total));const loader=document.querySelector(".loader");loader.classList.remove(".hide"),loader.classList.add(".show")},createExcelFromJSON=(res,op)=>{let listado=[];const wb=XLSX.utils.book_new(),dr=new Date,dateFile=dr.getDate(),month=dr.getMonth()+1,year=dr.getFullYear(),min=dr.getMinutes(),hour=dr.getHours();if(wb.Props={Title:"Course report",Subject:"Training program report",Author:"Alberto MarÃ­n",CreateDate:new Date(year,month,dateFile)},"courseReport"===op){if(res[0].assessment_list.length>0){listado=res[0].assessment_list.map((elem=>{const sdate=new Date(1e3*elem.startdate),syear=sdate.getFullYear(),smonth=sdate.getMonth()+1,sday=sdate.getDate()+1;elem.startdate=new Date(syear+"-"+smonth+"-"+sday);const edate=new Date(1e3*elem.enddate),eyear=edate.getFullYear(),emonth=edate.getMonth()+1,eday=edate.getDate()+1;return elem.enddate=new Date(eyear+"-"+emonth+"-"+eday),elem.assessment=1*elem.assessment,elem.assessment=parseFloat(elem.assessment),elem.assessment=Math.round(100*elem.assessment)/100,elem.attendance=1*elem.attendance,elem.attendance=parseFloat(elem.attendance),elem.attendance=Math.round(100*elem.attendance)/100,delete elem.customerid,delete elem.groupid,Object.values(elem)})),res[0].ifobserver&&(listado=res[0].assessment_list.map((elem=>(delete elem.customercode,Object.values(elem)))));let titles=Object.keys(res[0].assessment_list[0]);listado.unshift(titles)}wb.SheetNames.push("courseAssessment");const ws=XLSX.utils.aoa_to_sheet(listado);wb.Sheets.courseAssessment=ws}if("traineeReport"===op){if(res[0].assessment_list.length>0){const groupedByMail=res[0].assessment_list.reduce(((acc,curr)=>{const{customercode:customercode,groupname:groupname,billid:billid,firstname:firstname,lastname:lastname,email:email,assessment:assessment,attendance:attendance}=curr;return acc[email]||(acc[email]={customercode:customercode,groupname:groupname,billid:billid,firstname:firstname,lastname:lastname,email:email,count:0,sumAssessment:0,sumAttendance:0}),acc[email].count++,acc[email].sumAssessment+=1*parseFloat(assessment),acc[email].sumAttendance+=1*parseFloat(attendance),acc}),{});listado=Object.entries(groupedByMail).map((_ref=>{let[email,{customercode:customercode,groupname:groupname,billid:billid,firstname:firstname,lastname:lastname,count:count,sumAssessment:sumAssessment,sumAttendance:sumAttendance}]=_ref;return{customercode:customercode,groupname:groupname,billid:billid,firstname:firstname,lastname:lastname,email:email,attendance:sumAttendance/count,assessment:sumAssessment/count}})).map((elem=>(elem.assessment=1*elem.assessment,elem.assessment=parseFloat(elem.assessment),elem.assessment=Math.round(100*elem.assessment)/100,elem.attendance=1*elem.attendance,elem.attendance=parseFloat(elem.attendance),elem.attendance=Math.round(100*elem.attendance)/100,delete elem.customerid,delete elem.groupid,Object.values(elem)))),listado.unshift(["customercode","group","billid","firstname","lastname","email","attendance","assessment"])}wb.SheetNames.push("traineeReport");const ws=XLSX.utils.aoa_to_sheet(listado);wb.Sheets.traineeReport=ws}if("dailyAttendanceReport"===op){if(res[0].attendance_list.length>0){listado=res[0].attendance_list.map((elem=>{const date=new Date(1e3*elem.dateatt),year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate()+1;return elem.dateatt=new Date(year+"-"+month+"-"+day),Object.values(elem)}));let titles=Object.keys(res[0].attendance_list[0]);listado.unshift(titles)}wb.SheetNames.push("AttendanceReport");const ws=XLSX.utils.aoa_to_sheet(listado);wb.Sheets.AttendanceReport=ws}const wbout=XLSX.write(wb,{bookType:"xlsx",type:"binary"}),nameFile=op+dateFile+"."+month+"."+year+"."+hour+"."+min+".xlsx";saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}),nameFile)},s2ab=s=>{for(var buf=new ArrayBuffer(s.length),view=new Uint8Array(buf),i=0;i!=s.length;++i)view[i]=255&s.charCodeAt(i);return buf}}));

//# sourceMappingURL=exportExcel.min.js.map