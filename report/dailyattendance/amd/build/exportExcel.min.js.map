{"version":3,"file":"exportExcel.min.js","sources":["../src/exportExcel.js"],"sourcesContent":["\nexport const init=(XLSX, filesaver,blobutil,token)=>{\n    const boexport=document.querySelector('#idexport');\n    boexport.addEventListener('click',(e)=>{\n        const loader=document.querySelector('.loader');\n        loader.classList.remove('hide');\n        loader.classList.add('show');\n        exportToExcel(e,XLSX,filesaver,blobutil,token);\n    });\n}\n\nconst exportToExcel=(e,XLSX,filesaver,blobutil,token)=>{\n    const data={\n        orderby:'DateAtt',\n        customerid:document.querySelector('#customerid').value,\n        groupid:document.querySelector('#selgroupid').value,\n        billid:document.querySelector('#billid').value,\n        attP:(document.querySelector('#chkPresent').checked)?true:false,\n        attA:(document.querySelector('#chkAbsent').checked)?true:false,\n        attL:(document.querySelector('#chkLate').checked)?true:false,\n        attE:(document.querySelector('#chkExcused').checked)?true:false,\n        startdate:document.querySelector('#startdate').value,\n        enddate:document.querySelector('#enddate').value,\n        token:token\n    }\n    prepareDataToSend(data);\n}\n\nconst prepareDataToSend=(data)=>{\n    const xhr=new XMLHttpRequest();\n    const url=window.location.protocol+'//'+window.location.hostname+'/webservice/rest/server.php';\n    xhr.open('POST',url,true);\n \n    const formData= new FormData();\n    formData.append('wstoken',data.token);\n    formData.append('wsfunction','report_dailyattendance_get_list_courses');\n    formData.append('moodlewsrestformat','json');\n    formData.append('params[0][customerid]',data.customerid);\n    formData.append('params[0][order]','ASC');\n    formData.append('params[0][orderby]',data.orderby);\n    formData.append('params[0][groupid]',data.groupid);\n    formData.append('params[0][billid]',data.billid);\n    formData.append('params[0][page]',0);\n    formData.append('params[0][offset]',100);\n    formData.append('params[0][startdate]',Math.floor(new Date(data.startdate).getTime() / 1000));\n    formData.append('params[0][enddate]',Math.floor(new Date(data.enddate).getTime() / 1000));\n    formData.append('params[0][attendanceStatus][statusPresent]',data.attP);\n    formData.append('params[0][attendanceStatus][statusAbsent]',data.attA);\n    formData.append('params[0][attendanceStatus][statusLate]',data.attL);\n    formData.append('params[0][attendanceStatus][statusExcused]',data.attE);\n\n    xhr.send(formData);\n    xhr.onload=(event)=>{\n        onLoadFunction(xhr);\n    }\n\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n\n    xhr.onloadend=(event)=>{\n        const loader=document.querySelector('.loader');\n        loader.classList.remove('show');\n        loader.classList.add('hide');\n    };\n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n\n}\n\nconst onLoadFunction=(myXhr)=>{\n    const loader=document.querySelector('.loader');\n    loader.classList.add('.hide');\n    loader.classList.remove('.show');\n\n    if (myXhr.readyState===4 && myXhr.status===200){\n        const res=JSON.parse(myXhr.response);\n        createExcelFromJSON(res,'dailyattendance');\n        \n    }\n}\n\nconst onProgressFunction=(event) =>{\n    console.log(`Uploaded ${event.loaded} of ${event.total}`);\n    const loader=document.querySelector('.loader');\n    loader.classList.remove('.hide');\n    loader.classList.add('.show');\n}\n\nconst createExcelFromJSON=(res,op)=>{\n    let listado=[];\n    if (res[0].attendance_list.length>0){\n        listado=res[0].attendance_list.map(elem=>{\n            const date=new Date(elem.dateatt*1000);\n            const year=date.getFullYear();\n            const month=date.getMonth()+1;\n            const day=date.getDate()+1;\n            elem.dateatt=new Date(year+\"-\"+month+\"-\"+day);\n            return Object.values(elem);\n        });\n        let titles=Object.keys(res[0].attendance_list[0]);\n        listado.unshift(titles);\n    }\n    \n    const wb=XLSX.utils.book_new();\n    const dr=new Date();\n    const dateFile=dr.getDate();\n    const month=dr.getMonth()+1\n    const year=dr.getFullYear();\n    const min=dr.getMinutes();\n    const hour=dr.getHours();\n    \n    wb.Props={\n        Title: \"Daily attendance report\",\n        Subject: \"Training program report\",\n        Author: \"Alberto MarÃ­n\",\n        CreateDate: new Date(year,month,dateFile)\n    };\n    wb.SheetNames.push(\"daily attendance\");\n    \n    const ws=XLSX.utils.aoa_to_sheet(listado);\n    wb.Sheets[\"daily attendance\"]=ws;\n    const wbout=XLSX.write(wb,{bookType:'xlsx',type:'binary'});\n    const nameFile='dailyReport_'+dateFile+'.'+month+'.'+year+'.'+hour+'.'+min+'.xlsx';\n    saveAs(new Blob([s2ab(wbout)],{type:\"application/octet-stream\"}),nameFile)\n    \n}\n\nconst s2ab=(s) => {\n    var buf = new ArrayBuffer(s.length);\n    var view = new Uint8Array(buf);\n    for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;\n    return buf;\n}"],"names":["XLSX","filesaver","blobutil","token","document","querySelector","addEventListener","e","loader","classList","remove","add","exportToExcel","data","orderby","customerid","value","groupid","billid","attP","checked","attA","attL","attE","startdate","enddate","prepareDataToSend","xhr","XMLHttpRequest","url","window","location","protocol","hostname","open","formData","FormData","append","Math","floor","Date","getTime","send","onload","event","onLoadFunction","onprogress","onProgressFunction","onloadend","onerror","console","log","myXhr","readyState","status","res","JSON","parse","response","createExcelFromJSON","loaded","total","op","listado","attendance_list","length","map","elem","date","dateatt","year","getFullYear","month","getMonth","day","getDate","Object","values","titles","keys","unshift","wb","utils","book_new","dr","dateFile","min","getMinutes","hour","getHours","Props","Title","Subject","Author","CreateDate","SheetNames","push","ws","aoa_to_sheet","Sheets","wbout","write","bookType","type","nameFile","saveAs","Blob","s2ab","s","buf","ArrayBuffer","view","Uint8Array","i","charCodeAt"],"mappings":"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"}