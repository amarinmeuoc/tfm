{"version":3,"file":"exportExcel.min.js","sources":["../src/exportExcel.js"],"sourcesContent":["\nexport const init=(XLSX, filesaver,blobutil)=>{\n    const boexport=document.querySelector('#idexport');\n    boexport.addEventListener('click',(e)=>{\n        exportToExcel(e,XLSX,filesaver,blobutil);\n    });\n}\n\nconst exportToExcel=(e,XLSX,filesaver,blobutil)=>{\n    const token=document.querySelector('input[name=\"token\"]').value;\n    const startdate_day=document.querySelector('#id_startdate_day');\n    const startdate_month=document.querySelector('#id_startdate_month');\n    const startdate_year=document.querySelector('#id_startdate_year');\n    const startdate=Math.floor(new Date(startdate_year.value+'.'+startdate_month.value+'.'+startdate_day.value).getTime()/1000);\n    const data={\n        orderby:'startdate',\n        customerid:document.querySelector('#id_customer').value,\n        groupid:document.querySelector('#id_grouptrainee').value,\n        billid:document.querySelector('#id_list_trainees').value,\n        role:document.querySelector('#id_role').value,\n        wbs:document.querySelector('#id_list_courses').value,\n        startdate:startdate,\n        queryType:document.querySelector('input[type=\"radio\"][name=\"status\"]:checked').value,\n        token:token\n    }\n    prepareDataToSend(data);\n}\n\nconst prepareDataToSend=(data)=>{\n    const xhr=new XMLHttpRequest();\n    const url='http://'+window.location.hostname+'/webservice/rest/server.php';\n    xhr.open('POST',url,true);\n \n    const formData= new FormData();\n    formData.append('wstoken',data.token);\n    formData.append('wsfunction','report_coursereport_get_assessment');\n    formData.append('moodlewsrestformat','json');\n    formData.append('params[0][customerid]',data.customerid);\n    formData.append('params[0][order]',1);\n    formData.append('params[0][orderby]',data.orderby);\n    formData.append('params[0][groupid]',data.groupid);\n    formData.append('params[0][billid]',data.billid);\n    formData.append('params[0][page]',0);\n    formData.append('params[0][offset]',100);\n    formData.append('params[0][startdate]',data.startdate);\n    formData.append('params[0][queryType]',data.queryType);\n    formData.append('params[0][role]',data.role);\n    formData.append('params[0][wbs]',data.wbs);\n    \n    \n\n    xhr.send(formData);\n    xhr.onload=(event)=>{\n        onLoadFunction(xhr);\n    }\n\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n\n}\n\nconst onLoadFunction=(myXhr)=>{\n    const loader=document.querySelector('.loader');\n    loader.classList.add('.hide');\n    loader.classList.remove('.show');\n\n    if (myXhr.readyState===4 && myXhr.status===200){\n        const res=JSON.parse(myXhr.response);\n        createExcelFromJSON(res,'courseReport');\n        \n    }\n}\n\nconst onProgressFunction=(event) =>{\n    console.log(`Uploaded ${event.loaded} of ${event.total}`);\n    const loader=document.querySelector('.loader');\n    loader.classList.remove('.hide');\n    loader.classList.add('.show');\n}\n\nconst createExcelFromJSON=(res,op)=>{\n    \n    let listado=[];\n    if (res[0].assessment_list.length>0){\n        listado=res[0].assessment_list.map(elem=>{\n            const sdate=new Date(elem.startdate*1000);\n            const syear=sdate.getFullYear();\n            const smonth=sdate.getMonth()+1;\n            const sday=sdate.getDate()+1;\n            elem.startdate=new Date(syear+\"-\"+smonth+\"-\"+sday);\n            const edate=new Date(elem.enddate*1000);\n            const eyear=edate.getFullYear();\n            const emonth=edate.getMonth()+1;\n            const eday=edate.getDate()+1;\n            elem.enddate=new Date(eyear+\"-\"+emonth+\"-\"+eday);\n            elem.assessment=elem.assessment*1;\n            elem.assessment=parseFloat(elem.assessment);\n            elem.assessment= Math.round(elem.assessment*100)/100;\n            elem.attendance=elem.attendance*1;\n            elem.attendance=parseFloat(elem.attendance);\n            elem.attendance= Math.round(elem.attendance*100)/100;\n            delete elem.customerid;\n            delete elem.groupid;\n\n            return Object.values(elem);\n        });\n        if (res[0].ifobserver){\n            listado=res[0].assessment_list.map(elem=>{\n                delete elem.customercode;\n                return Object.values(elem);\n            });\n        }\n        let titles=Object.keys(res[0].assessment_list[0]);\n        listado.unshift(titles);\n    }\n    \n    const wb=XLSX.utils.book_new();\n    const dr=new Date();\n    const dateFile=dr.getDate();\n    const month=dr.getMonth()+1\n    const year=dr.getFullYear();\n    const min=dr.getMinutes();\n    const hour=dr.getHours();\n    \n    wb.Props={\n        Title: \"Course assessment report\",\n        Subject: \"Training program report\",\n        Author: \"Alberto MarÃ­n\",\n        CreateDate: new Date(year,month,dateFile)\n    };\n    wb.SheetNames.push(\"courseAssessment\");\n    \n    const ws=XLSX.utils.aoa_to_sheet(listado);\n    wb.Sheets[\"courseAssessment\"]=ws;\n    const wbout=XLSX.write(wb,{bookType:'xlsx',type:'binary'});\n    const nameFile='assessmentReport'+dateFile+'.'+month+'.'+year+'.'+hour+'.'+min+'.xlsx';\n    saveAs(new Blob([s2ab(wbout)],{type:\"application/octet-stream\"}),nameFile)\n    \n}\n\nconst s2ab=(s) => {\n    var buf = new ArrayBuffer(s.length);\n    var view = new Uint8Array(buf);\n    for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;\n    return buf;\n}"],"names":["XLSX","filesaver","blobutil","document","querySelector","addEventListener","e","exportToExcel","token","value","startdate_day","startdate_month","startdate_year","startdate","Math","floor","Date","getTime","data","orderby","customerid","groupid","billid","role","wbs","queryType","prepareDataToSend","xhr","XMLHttpRequest","url","window","location","hostname","open","formData","FormData","append","send","onload","event","onLoadFunction","onprogress","onProgressFunction","onerror","console","log","myXhr","loader","classList","add","remove","readyState","status","res","JSON","parse","response","createExcelFromJSON","loaded","total","op","listado","assessment_list","length","map","elem","sdate","syear","getFullYear","smonth","getMonth","sday","getDate","edate","enddate","eyear","emonth","eday","assessment","parseFloat","round","attendance","Object","values","ifobserver","customercode","titles","keys","unshift","wb","utils","book_new","dr","dateFile","month","year","min","getMinutes","hour","getHours","Props","Title","Subject","Author","CreateDate","SheetNames","push","ws","aoa_to_sheet","Sheets","wbout","write","bookType","type","nameFile","saveAs","Blob","s2ab","s","buf","ArrayBuffer","view","Uint8Array","i","charCodeAt"],"mappings":"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"}