{"version":3,"file":"downloadcsv.min.js","sources":["../src/downloadcsv.js"],"sourcesContent":["export const init = (customerid) => {\n    let trainee_list=document.querySelectorAll('.bodownload');\n    trainee_list.forEach((node)=>{\n        node.addEventListener('click',(e)=>{\n            downloadcsv(e,customerid);\n            \n        });\n    })\n    \n}\n\nconst downloadcsv = (e,customerid)=>{\n    e.preventDefault();\n    const element=e.target.closest('a');\n    let list_of_trainees=element.getAttribute('data-id');\n    list_of_trainees=list_of_trainees.split(\",\");\n    list_of_trainees=list_of_trainees.reduce((arr,elem)=>{\n        const aux= elem.split(\"_\");\n        return [...arr,{group:aux[0],billid:aux[1]}];\n    },[]);\n    \n    const xhr=new XMLHttpRequest();\n    const url=window.location.protocol+'//'+window.location.hostname+'/webservice/rest/server.php';\n    xhr.open('POST',url,true);\n    const formData= new FormData();\n    const token=document.querySelector('#id_token').value;\n    formData.append('wstoken',token);\n    formData.append('wsfunction','report_partialplan_get_trainees');\n    formData.append('moodlewsrestformat','json');\n    \n    for (let i=0;i<list_of_trainees.length;i++){\n        const group=list_of_trainees[i].group.trim();\n        const billid=list_of_trainees[i].billid.trim();\n        formData.append(`params[${i}][customerid]`,parseInt(customerid));\n        formData.append(`params[${i}][group]`,group);\n        formData.append(`params[${i}][billid]`,billid);\n    }\n            \n    xhr.send(formData);\n    xhr.onload = (event) =>{\n        onLoadFunction(xhr);\n        };\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n}\nconst onLoadFunction=(myXhr)=>{\n    if (myXhr.readyState=== 4 && myXhr. status === 200){\n      const res=JSON.parse(myXhr.response);\n\n      //Prepare the excel for to be downloaded\n      createExcelFromJSON(res);\n  }\n  }\n\nconst onProgressFunction= (event)=>{\n    if (event.lengthComputable) {\n      window.console.log(`Recibidos ${event.loaded} de ${event.total} bytes`);\n    } else {\n      window.console.log(`Recibidos ${event.loaded} bytes`); // sin Content-Length\n    }\n}\n\nconst createExcelFromJSON=(res)=>{\n  \n    if (res.length>0){\n        const titles=Object.keys(res[0]);\n        res=res.map(elem=>{\n            return Object.values(elem);\n        })\n        res.unshift(titles);\n    }\n    \n    let csvContent='';\n    res.forEach(row=>{\n        csvContent+=row.join(';')+'\\n';\n    })\n    const blob = new Blob(['\\uFEFF' +csvContent], { type: 'text/csv;charset=utf-16;' });\n    \n    const objUrl = URL.createObjectURL(blob);\n    const dr=new Date();\n    const dateFile=dr.getDate();\n    const month=dr.getMonth()+1\n    const year=dr.getFullYear();\n    const nameFile='Trainee_list_loader_'+dateFile+'.'+month+'.'+year+'.csv';\n    const link = document.createElement('a');\n    link.setAttribute('href', objUrl);\n    link.setAttribute('download', nameFile);\n    \n    link.click();\n    return;\n    \n\n    \n   \n}\n\n"],"names":["customerid","document","querySelectorAll","forEach","node","addEventListener","e","downloadcsv","preventDefault","list_of_trainees","target","closest","getAttribute","split","reduce","arr","elem","aux","group","billid","xhr","XMLHttpRequest","url","window","location","protocol","hostname","open","formData","FormData","token","querySelector","value","append","i","length","trim","parseInt","send","onload","event","onLoadFunction","onprogress","onProgressFunction","onerror","console","log","myXhr","readyState","status","res","JSON","parse","response","createExcelFromJSON","lengthComputable","loaded","total","titles","Object","keys","map","values","unshift","csvContent","row","join","blob","Blob","type","objUrl","URL","createObjectURL","dr","Date","nameFile","getDate","getMonth","getFullYear","link","createElement","setAttribute","click"],"mappings":"mKAAqBA,aACAC,SAASC,iBAAiB,eAC9BC,SAASC,OAClBA,KAAKC,iBAAiB,SAASC,IAC3BC,YAAYD,EAAEN,yBAOpBO,YAAc,CAACD,EAAEN,cACnBM,EAAEE,qBAEEC,iBADUH,EAAEI,OAAOC,QAAQ,KACFC,aAAa,WAC1CH,iBAAiBA,iBAAiBI,MAAM,KACxCJ,iBAAiBA,iBAAiBK,QAAO,CAACC,IAAIC,cACpCC,IAAKD,KAAKH,MAAM,WACf,IAAIE,IAAI,CAACG,MAAMD,IAAI,GAAGE,OAAOF,IAAI,OAC1C,UAEIG,IAAI,IAAIC,eACRC,IAAIC,OAAOC,SAASC,SAAS,KAAKF,OAAOC,SAASE,SAAS,8BACjEN,IAAIO,KAAK,OAAOL,KAAI,SACdM,SAAU,IAAIC,SACdC,MAAM7B,SAAS8B,cAAc,aAAaC,MAChDJ,SAASK,OAAO,UAAUH,OAC1BF,SAASK,OAAO,aAAa,mCAC7BL,SAASK,OAAO,qBAAqB,YAEhC,IAAIC,EAAE,EAAEA,EAAEzB,iBAAiB0B,OAAOD,IAAI,OACjChB,MAAMT,iBAAiByB,GAAGhB,MAAMkB,OAChCjB,OAAOV,iBAAiByB,GAAGf,OAAOiB,OACxCR,SAASK,wBAAiBC,mBAAiBG,SAASrC,aACpD4B,SAASK,wBAAiBC,cAAYhB,OACtCU,SAASK,wBAAiBC,eAAaf,QAG3CC,IAAIkB,KAAKV,UACTR,IAAImB,OAAUC,QACVC,eAAerB,MAEnBA,IAAIsB,WAAcF,QACdG,mBAAmBH,QAEvBpB,IAAIwB,QAAU,WACVrB,OAAOsB,QAAQC,IAAI,uBAGrBL,eAAgBM,WACM,IAApBA,MAAMC,YAAqC,MAAlBD,MAAOE,OAAe,OAC3CC,IAAIC,KAAKC,MAAML,MAAMM,UAG3BC,oBAAoBJ,OAIpBP,mBAAqBH,QACnBA,MAAMe,iBACRhC,OAAOsB,QAAQC,wBAAiBN,MAAMgB,sBAAahB,MAAMiB,iBAEzDlC,OAAOsB,QAAQC,wBAAiBN,MAAMgB,mBAItCF,oBAAqBJ,SAEnBA,IAAIf,OAAO,EAAE,OACPuB,OAAOC,OAAOC,KAAKV,IAAI,KAC7BA,IAAIA,IAAIW,KAAI7C,MACD2C,OAAOG,OAAO9C,SAErB+C,QAAQL,YAGZM,WAAW,GACfd,IAAI/C,SAAQ8D,MACRD,YAAYC,IAAIC,KAAK,KAAK,cAExBC,KAAO,IAAIC,KAAK,CAAC,SAAUJ,YAAa,CAAEK,KAAM,6BAEhDC,OAASC,IAAIC,gBAAgBL,MAC7BM,GAAG,IAAIC,KAIPC,SAAS,uBAHAF,GAAGG,UAG6B,KAFnCH,GAAGI,WAAW,GAE+B,IAD9CJ,GAAGK,cACoD,OAC5DC,KAAO9E,SAAS+E,cAAc,KACpCD,KAAKE,aAAa,OAAQX,QAC1BS,KAAKE,aAAa,WAAYN,UAE9BI,KAAKG"}