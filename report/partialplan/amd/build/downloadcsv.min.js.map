{"version":3,"file":"downloadcsv.min.js","sources":["../src/downloadcsv.js"],"sourcesContent":["export const init = (customerid) => {\n    let trainee_list=document.querySelectorAll('.bodownload');\n    trainee_list.forEach((node)=>{\n        node.addEventListener('click',(e)=>{\n            downloadcsv(e,customerid);\n        });\n    })\n    \n    window.console.log(\"show trainees... \");\n}\n\nconst downloadcsv=(e,customerid)=>{\n    e.stopPropagation(); //To avoid the event bubbles up further up the DOM tree, stopping it at the button element\n    const element=e.target.closest('a');\n    let list_of_trainees=element.getAttribute('data-id');\n    list_of_trainees=list_of_trainees.split(\",\");\n    list_of_trainees=list_of_trainees.reduce((arr,elem)=>{\n        const aux= elem.split(\"_\");\n        return [...arr,{group:aux[0],billid:aux[1]}];\n    },[]);\n    //window.console.log(list_of_trainees);\n    \n    const xhr=new XMLHttpRequest();\n    const url=window.location.protocol+'//'+window.location.hostname+'/webservice/rest/server.php';\n    xhr.open('POST',url,true);\n    const token=document.querySelector('#id_token').value;\n    const formData= new FormData();\n    formData.append('wstoken',token);\n    formData.append('wsfunction','report_partialplan_get_trainees');\n    formData.append('moodlewsrestformat','json');\n    for (let i=0;i<list_of_trainees.length;i++){\n        const group=list_of_trainees[i].group.trim();\n        const billid=list_of_trainees[i].billid.trim();\n        formData.append(`params[${i}][customerid]`,parseInt(customerid));\n        formData.append(`params[${i}][group]`,group);\n        formData.append(`params[${i}][billid]`,billid);\n    }\n            \n    xhr.send(formData);\n    xhr.onload = (event) =>{\n        onLoadFunction(xhr,element);\n        \n        };\n    xhr.onprogress = (event)=>{\n        onProgressFunction(event);\n    } \n    xhr.onerror = function() {\n        window.console.log(\"Solicitud fallida\");\n    };\n        \n   \n    \n}\n\nconst onLoadFunction=(myXhr,element)=>{\n    if (myXhr.readyState=== 4 && myXhr. status === 200){\n      const res=JSON.parse(myXhr.response);\n      \n      //getting tittle keys\n      const titleKeys=Object.keys(res[0]);\n      const refinedData=[];\n\n      refinedData.push(titleKeys);\n      res.forEach(item=>{\n        refinedData.push(Object.values(item));\n      });\n\n      let csvContent='';\n      refinedData.forEach(row=>{\n        csvContent+=row.join(';')+'\\n';\n      });\n\n      const blob= new Blob([csvContent],{type:'text/csv;charset=utf-8,'});\n      const objURL=URL.createObjectURL(blob);\n      element.setAttribute('href',objURL);\n      element.setAttribute('download','file.csv');\n      \n        \n  }\n  }\n  \n  const onProgressFunction= (event)=>{\n      if (event.lengthComputable) {\n        window.console.log(`Recibidos ${event.loaded} de ${event.total} bytes`);\n      } else {\n        window.console.log(`Recibidos ${event.loaded} bytes`); // sin Content-Length\n      }\n  }"],"names":["customerid","document","querySelectorAll","forEach","node","addEventListener","e","downloadcsv","window","console","log","stopPropagation","element","target","closest","list_of_trainees","getAttribute","split","reduce","arr","elem","aux","group","billid","xhr","XMLHttpRequest","url","location","protocol","hostname","open","token","querySelector","value","formData","FormData","append","i","length","trim","parseInt","send","onload","event","onLoadFunction","onprogress","onProgressFunction","onerror","myXhr","readyState","status","res","JSON","parse","response","titleKeys","Object","keys","refinedData","push","item","values","csvContent","row","join","blob","Blob","type","objURL","URL","createObjectURL","setAttribute","lengthComputable","loaded","total"],"mappings":"mKAAqBA,aACAC,SAASC,iBAAiB,eAC9BC,SAASC,OAClBA,KAAKC,iBAAiB,SAASC,IAC3BC,YAAYD,EAAEN,kBAItBQ,OAAOC,QAAQC,IAAI,4BAGjBH,YAAY,CAACD,EAAEN,cACjBM,EAAEK,wBACIC,QAAQN,EAAEO,OAAOC,QAAQ,SAC3BC,iBAAiBH,QAAQI,aAAa,WAC1CD,iBAAiBA,iBAAiBE,MAAM,KACxCF,iBAAiBA,iBAAiBG,QAAO,CAACC,IAAIC,cACpCC,IAAKD,KAAKH,MAAM,WACf,IAAIE,IAAI,CAACG,MAAMD,IAAI,GAAGE,OAAOF,IAAI,OAC1C,UAGIG,IAAI,IAAIC,eACRC,IAAIlB,OAAOmB,SAASC,SAAS,KAAKpB,OAAOmB,SAASE,SAAS,8BACjEL,IAAIM,KAAK,OAAOJ,KAAI,SACdK,MAAM9B,SAAS+B,cAAc,aAAaC,MAC1CC,SAAU,IAAIC,SACpBD,SAASE,OAAO,UAAUL,OAC1BG,SAASE,OAAO,aAAa,mCAC7BF,SAASE,OAAO,qBAAqB,YAChC,IAAIC,EAAE,EAAEA,EAAEtB,iBAAiBuB,OAAOD,IAAI,OACjCf,MAAMP,iBAAiBsB,GAAGf,MAAMiB,OAChChB,OAAOR,iBAAiBsB,GAAGd,OAAOgB,OACxCL,SAASE,wBAAiBC,mBAAiBG,SAASxC,aACpDkC,SAASE,wBAAiBC,cAAYf,OACtCY,SAASE,wBAAiBC,eAAad,QAG3CC,IAAIiB,KAAKP,UACTV,IAAIkB,OAAUC,QACVC,eAAepB,IAAIZ,UAGvBY,IAAIqB,WAAcF,QACdG,mBAAmBH,QAEvBnB,IAAIuB,QAAU,WACVvC,OAAOC,QAAQC,IAAI,uBAOrBkC,eAAe,CAACI,MAAMpC,cACA,IAApBoC,MAAMC,YAAqC,MAAlBD,MAAOE,OAAe,OAC3CC,IAAIC,KAAKC,MAAML,MAAMM,UAGrBC,UAAUC,OAAOC,KAAKN,IAAI,IAC1BO,YAAY,GAElBA,YAAYC,KAAKJ,WACjBJ,IAAIhD,SAAQyD,OACVF,YAAYC,KAAKH,OAAOK,OAAOD,cAG7BE,WAAW,GACfJ,YAAYvD,SAAQ4D,MAClBD,YAAYC,IAAIC,KAAK,KAAK,cAGtBC,KAAM,IAAIC,KAAK,CAACJ,YAAY,CAACK,KAAK,4BAClCC,OAAOC,IAAIC,gBAAgBL,MACjCrD,QAAQ2D,aAAa,OAAOH,QAC5BxD,QAAQ2D,aAAa,WAAW,cAM9BzB,mBAAqBH,QACnBA,MAAM6B,iBACRhE,OAAOC,QAAQC,wBAAiBiC,MAAM8B,sBAAa9B,MAAM+B,iBAEzDlE,OAAOC,QAAQC,wBAAiBiC,MAAM8B"}